<div class="container">
  <div class="header">
    <h2>Edit Project</h2>
    <button mat-raised-button color="warn" (click)="deleteProject()">
      <mat-icon>delete</mat-icon>
      Delete Project
    </button>
  </div>

  <mat-spinner *ngIf="loading" diameter="50"></mat-spinner>

  <div *ngIf="!loading" class="content">
    <!-- Project Form Card -->
    <div class="form-card">
      <h3>Project Details</h3>
      <form [formGroup]="projectForm" (ngSubmit)="onSubmit()">
        <!-- Project Name Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Project Name</mat-label>
          <input matInput formControlName="projectName" placeholder="Enter project name">
          <mat-icon matPrefix>work</mat-icon>
          <mat-error *ngIf="projectForm.get('projectName')?.hasError('required')">
            Project name is required
          </mat-error>
          <mat-error *ngIf="projectForm.get('projectName')?.hasError('minlength')">
            Project name must be at least 2 characters
          </mat-error>
        </mat-form-field>

        <!-- Description Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description</mat-label>
          <textarea matInput formControlName="description" placeholder="Enter project description" rows="4"></textarea>
          <mat-icon matPrefix>description</mat-icon>
          <mat-error *ngIf="projectForm.get('description')?.hasError('required')">
            Description is required
          </mat-error>
          <mat-error *ngIf="projectForm.get('description')?.hasError('minlength')">
            Description must be at least 10 characters
          </mat-error>
        </mat-form-field>

        <!-- Date Fields Row -->
        <div class="date-row">
          <!-- Start Date Field -->
          <mat-form-field appearance="outline" class="date-field">
            <mat-label>Start Date</mat-label>
            <input matInput [matDatepicker]="startPicker" formControlName="startDate">
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
            <mat-icon matPrefix>event</mat-icon>
            <mat-error *ngIf="projectForm.get('startDate')?.hasError('required')">
              Start date is required
            </mat-error>
          </mat-form-field>

          <!-- End Date Field -->
          <mat-form-field appearance="outline" class="date-field">
            <mat-label>End Date</mat-label>
            <input matInput [matDatepicker]="endPicker" formControlName="endDate">
            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
            <mat-icon matPrefix>event</mat-icon>
            <mat-hint>Optional</mat-hint>
          </mat-form-field>
        </div>

        <!-- Status Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status">
            <mat-option *ngFor="let status of statuses" [value]="status">{{ status }}</mat-option>
          </mat-select>
          <mat-icon matPrefix>info</mat-icon>
          <mat-error *ngIf="projectForm.get('status')?.hasError('required')">
            Status is required
          </mat-error>
        </mat-form-field>

        <!-- Buttons -->
        <div class="button-group">
          <button mat-raised-button color="primary" type="submit" [disabled]="projectForm.invalid || saving">
            <mat-icon>save</mat-icon>
            {{ saving ? 'Saving...' : 'Save Changes' }}
          </button>
          <button mat-stroked-button type="button" (click)="cancel()">
            Cancel
          </button>
        </div>
      </form>
    </div>

    <!-- Employee Assignment Card -->
    <div class="form-card">
      <h3>Assign Employees</h3>

      <!-- Assignment Form -->
      <div class="assign-form">
        <mat-form-field appearance="outline" class="assign-field">
          <mat-label>Select Employee</mat-label>
          <mat-select [(ngModel)]="selectedEmployeeId" (ngModelChange)="onEmployeeSelect()">
            <mat-option [value]="0">-- Select Employee --</mat-option>
            <mat-option *ngFor="let emp of availableEmployees" [value]="emp.id">
              {{ emp.name }} - {{ emp.jobRole }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>person</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="assign-field">
          <mat-label>Role (Auto-filled)</mat-label>
          <input matInput [(ngModel)]="assignRole" placeholder="Auto-filled from employee" readonly>
          <mat-icon matPrefix>work</mat-icon>
        </mat-form-field>

        <button mat-raised-button color="accent" (click)="assignEmployee()">
          <mat-icon>add</mat-icon>
          Assign
        </button>
      </div>

      <!-- Assigned Employees Table -->
      <div class="assigned-section">
        <h4>Currently Assigned ({{ assignedEmployees.length }})</h4>

        <div *ngIf="assignedEmployees.length === 0" class="no-employees">
          No employees assigned yet.
        </div>

        <div *ngIf="assignedEmployees.length > 0" class="mat-elevation-z2">
          <table mat-table [dataSource]="assignedEmployees" class="employees-table">
            <ng-container matColumnDef="employeeId">
              <th mat-header-cell *matHeaderCellDef>Employee ID</th>
              <td mat-cell *matCellDef="let emp">{{ emp.employeeId }}</td>
            </ng-container>

            <ng-container matColumnDef="employeeName">
              <th mat-header-cell *matHeaderCellDef>Name</th>
              <td mat-cell *matCellDef="let emp">{{ emp.employeeName }}</td>
            </ng-container>

            <ng-container matColumnDef="role">
              <th mat-header-cell *matHeaderCellDef>Role</th>
              <td mat-cell *matCellDef="let emp">{{ emp.role || 'N/A' }}</td>
            </ng-container>

            <ng-container matColumnDef="assignedDate">
              <th mat-header-cell *matHeaderCellDef>Assigned Date</th>
              <td mat-cell *matCellDef="let emp">{{ emp.assignedDate | date: 'MMM d, yyyy' }}</td>
            </ng-container>

            <ng-container matColumnDef="action">
              <th mat-header-cell *matHeaderCellDef>Action</th>
              <td mat-cell *matCellDef="let emp">
                <button mat-mini-fab color="warn" (click)="removeEmployee(emp.employeeId, emp.employeeName)" [attr.aria-label]="'Remove ' + emp.employeeName">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
